name: Webapp CI

on:
  push:
    branches: ["main"]
    paths:
      - "webapp/**"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "webapp/**"
      - ".github/workflows/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  webapp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci
      - name: Build webapp
        run: npm run build --workspace=webapp

      - name: Run formatter, linter and import sorting.
        run: npm run check --workspace=webapp

      - name: Run tests with coverage
        run: npm run test --workspace=webapp -- --coverage.enabled --coverage.reporter=lcov --coverage.reporter=json-summary --coverage.reporter=text --coverage.reporter=html

      - name: Upload coverage artifact
        id: upload-coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: webapp/coverage/

      - name: Comment coverage on PR
        if: ${{ github.event_name == 'pull_request' }}. # Only comment on PRs, not on pushes to main since that step would otherwise fail.
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require("child_process");
            process.env.ARTIFACT_URL = "${{ steps.upload-coverage.outputs.artifact-url }}";
            require("./.github/scripts/comment-coverage.js");